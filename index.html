<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>TinyLLM</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.8.0/styles/default.min.css">
    <style>
        /* Reset some basic elements */
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        html {
            /* Set base font size for rem calculations */
            font-size: 16px;
        }
        body {
            font-family: Arial, sans-serif;
            line-height: 1.6;
        }
        button {
            cursor: pointer;
        }
        /* Header Styles */
        header {
            display: flex;
            flex-wrap: wrap;
            align-items: center;
            justify-content: space-between;
            background-color: #0d6efd;
            color: #fff;
            padding: 10px;
        }
        header h1 {
            font-size: 1.5em;
            margin: 0;
        }
        #settings-button {
            background: none;
            border: none;
            cursor: pointer;
            padding: 0;
            margin: 0;
            width: 32px;
            height: 32px;
            fill: #fff;
            font-size: 1.5rem;
        }
        #settings-button:hover {
            opacity: 0.8;
        }
        /* Dialog Styles */
        dialog {
            margin: auto;
            border: 1px solid #ccc;
            border-radius: 6pt;
            padding: 16px;
            box-shadow: 2pt 2pt 2pt #32323264;
            max-width: 500px;
            width: 90%;
            background-color: #fefefe;
        }
        dialog::backdrop {
            background: rgba(0, 0, 0, 0.3);
        }
        dialog header {
            display: flex;
            flex-direction: row;
            justify-content: space-between;
            align-items: center;
            border-bottom: 1px solid #ddd;
            padding-bottom: 10px;
            margin-bottom: 20px;
        }
        dialog header p {
            font-weight: bold;
            font-size: 1.5em;
            display: flex;
            align-items: center;
            margin: 0;
        }
        dialog header p::before {
            content: '⚙️';
            margin-right: 8px;
        }
        dialog header button {
            background: none;
            border: none;
            font-size: 1.2em;
            cursor: pointer;
        }
        dialog table {
            width: 100%;
            border-collapse: collapse;
        }
        dialog table td {
            padding: 8px 4px;
            vertical-align: middle;
        }
        dialog table input,
        dialog table select,
        dialog table textarea {
            width: 100%;
            padding: 6px;
            border: 1px solid #ccc;
            border-radius: 4px;
        }
        dialog button {
            margin-top: 20px;
            padding: 10px 16px;
            background-color: #0d6efd;
            color: #fff;
            border: none;
            border-radius: 4px;
            cursor: pointer;
        }
        dialog button:hover {
            background-color: #0b5ed7;
        }
        button#settings-button {
            background-color: white;
            border-radius: 100%;
        }
        /* Main Styles */
        main {
            width: min(100%, 90ch);
            margin: 10px auto;
            border: 1px solid #323232;
            border-radius: 6pt;
            display: flex;
            flex-direction: column;
            overflow: hidden;
        }
        #chat-history {
            flex-grow: 1;
            padding: 16px;
            overflow-y: auto;
            background-color: #f9f9f9;
        }
        .message {
            margin-bottom: 16px;
            line-height: 1.4em;
            word-wrap: break-word;
            word-break: break-word;
        }
        .message.user {
            text-align: right;
        }
        .message.user p {
            background-color: #d1e7dd;
            color: #0f5132;
            display: inline-block;
            padding: 8px 12px;
            border-radius: 12px;
            max-width: 100%;
            word-wrap: break-word;
            white-space: pre-wrap;
            text-align: left;
        }
        .message.bot {
            text-align: left;
        }
        .message.bot p {
            background-color: #e2e3e5;
            color: #41464b;
            display: inline-block;
            padding: 8px 12px;
            border-radius: 12px;
            max-width: 100%;
            word-wrap: break-word;
            white-space: pre-wrap;
        }
        /* Form Styles */
        .form {
            display: flex;
            border-top: 1px solid #ddd;
        }
        .form textarea {
            flex-grow: 1;
            padding: 12px;
            border: none;
            font-size: 1em;
            resize: none;
            height: 60px;
        }
        .form button {
            padding: 0 16px;
            border: none;
            background-color: #0d6efd;
            color: white;
            font-size: 1em;
        }
        .form button:hover {
            background-color: #0b5ed7;
        }
        .disclaimer {
            margin-top: 20px;
            font-size: 0.9em;
            color: #555;
            text-align: center;
            font-style: italic;
        }
        /* Styles for Markdown Elements */
        .markdown-content h1 {
            font-size: 2em;
            margin-bottom: 0.5em;
        }
        .markdown-content h2 {
            font-size: 1.75em;
            margin-bottom: 0.5em;
        }
        .markdown-content h3 {
            font-size: 1.5em;
            margin-bottom: 0.5em;
        }
        .markdown-content h4 {
            font-size: 1.25em;
            margin-bottom: 0.5em;
        }
        .markdown-content h5 {
            font-size: 1em;
            margin-bottom: 0.5em;
        }
        .markdown-content h6 {
            font-size: 0.85em;
            margin-bottom: 0.5em;
        }
        .markdown-content p {
            margin-bottom: 1em;
        }
        .markdown-content strong {
            font-weight: bold;
        }
        .markdown-content em {
            font-style: italic;
        }
        .markdown-content blockquote {
            border-left: 4px solid #ccc;
            padding-left: 1em;
            color: #666;
            margin: 1em 0;
        }
        .markdown-content ul,
        .markdown-content ol {
            margin-left: 1.5em;
            margin-bottom: 1em;
        }
        .markdown-content li {
            margin-bottom: 0.5em;
        }
        .markdown-content code {
            font-family: Menlo, Monaco, Consolas, "Courier New", monospace;
            background-color: #f3f3f3;
            padding: 2px 4px;
            border-radius: 4px;
        }
        .markdown-content pre {
            background-color: #f3f3f3;
            padding: 8px;
            border-radius: 4px;
            overflow-x: auto;
        }
        .markdown-content pre code {
            display: block;
            padding: 0;
            background: none;
        }
        .markdown-content img {
            max-width: 100%;
            height: auto;
        }
        .markdown-content table {
            width: 100%;
            border-collapse: collapse;
            margin-bottom: 1em;
        }
        .markdown-content th,
        .markdown-content td {
            border: 1px solid #ddd;
            padding: 8px;
        }
        /* Ensure code blocks are scrollable on small screens */
        pre {
            overflow-x: auto;
        }
    </style>
    <!-- Include marked.js for Markdown parsing -->
    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.8.0/highlight.min.js"></script>
</head>
<body>
    <header>
        <h1>TinyLLM</h1>
        <button onclick="openSettings()" id="settings-button" title="Settings">
            ⚙️
        </button>
    </header>
    <dialog id="settings-dialog">
        <header>
            <p>Settings</p>
            <button onclick="closeSettings()" title="Close">&#x2715;</button>
        </header>
        <table>
            <tr>
                <td>API Type</td>
                <td>
                    <select id="api-type">
                        <option value="openai">OpenAI</option>
                        <option value="anthropic">Anthropic</option>
                    </select>
                </td>
            </tr>
            <tr>
                <td>API URL</td>
                <td><input type="text" id="api-url" placeholder="Enter API URL"></td>
            </tr>
            <tr>
                <td>API Key</td>
                <td><input type="password" id="api-key" placeholder="Enter API Key"></td>
            </tr>
            <tr>
                <td>Model</td>
                <td><input type="text" id="model" placeholder="e.g., gpt-3.5-turbo"></td>
            </tr>
            <tr>
                <td>System Prompt</td>
                <td><textarea id="system-prompt" placeholder="e.g., You are a helpful assistant." rows="4"></textarea></td>
            </tr>
        </table>
        <button onclick="saveSettings()">Save Settings</button>
        <div class="disclaimer">
            <p>Your settings are saved locally in your browser and never transferred to any third parties.</p>
        </div>
    </dialog>
    <main>
        <div class="chat-history" id="chat-history"></div>
        <div class="form">
            <textarea id="user-query" placeholder="Type your message..." rows="3"></textarea>
            <button onclick="askAI()">Submit</button>
        </div>
    </main>
    <script>
        marked.setOptions({
            gfm: true,
            breaks: true
        });
        let settings_dialog = document.getElementById("settings-dialog");
        let chat_history = []
        let max_tokens_map = {
            'gpt-4o-2024-08-06': 16384,
            'chatgpt-4o-latest': 16384,
            'gpt-4o-mini': 16384,
            'gpt-4o-mini-2024-07-18': 16384,
            'o1-preview': 32768,
            'o1-preview-2024-09-12': 32768,
            'o1-mini': 65536,
            'o1-mini-2024-09-12': 65536,
            'gpt-4': 8192,
            'gpt-4-0613': 8192,
            'gpt-4-0314': 8192 
        }

        function openSettings() {
            settings_dialog.showModal();
        }

        function closeSettings() {
            settings_dialog.close();
        }

        function saveSettings() {
            // Save settings to local storage
            localStorage.setItem('api-type', document.getElementById('api-type').value);
            localStorage.setItem('api-url', document.getElementById('api-url').value);
            localStorage.setItem('api-key', document.getElementById('api-key').value);
            localStorage.setItem('model', document.getElementById('model').value);
            localStorage.setItem('system-prompt', document.getElementById('system-prompt').value);
            closeSettings();
        }

        function loadSettings() {
            // Load settings from local storage
            document.getElementById('api-type').value = localStorage.getItem('api-type') || 'openai';
            document.getElementById('api-url').value = localStorage.getItem('api-url') || '';
            document.getElementById('api-key').value = localStorage.getItem('api-key') || '';
            document.getElementById('model').value = localStorage.getItem('model') || 'gpt-3.5-turbo';
            document.getElementById('system-prompt').value = localStorage.getItem('system-prompt') || 'You are a helpful assistant.';
        }

        loadSettings();

        async function queryLLMAPI() {
            const apiType = localStorage.getItem('api-type');
            const apiUrl = localStorage.getItem('api-url');
            const apiKey = localStorage.getItem('api-key');
            const model = localStorage.getItem('model') || 'gpt-3.5-turbo';

            if (!apiKey || !apiUrl) {
                alert('Please set your API key and API URL in the settings.');
                return "Error: API key or URL not set.";
            }

            try {
                let responseText = '';
                if (apiType === 'openai') {
                    let max_tokens = max_tokens_map[model] ?? 4096
                    if (model.startsWith('o1-')) {
                        chat_history = chat_history.filter((message) => {return message.role !== 'system'})
                    }
                    const response = await fetch(apiUrl, {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                            'Authorization': 'Bearer ' + apiKey
                        },
                        body: JSON.stringify({
                            model: model,
                            max_tokens: max_tokens,
                            messages: chat_history
                        })
                    });
                    const data = await response.json();
                    if (data.error) {
                        responseText = 'Error: ' + data.error.message;
                    } else {
                        responseText = data.choices[0].message.content.trim();
                    }
                } else if (apiType === 'anthropic') {
                    // TODO: rewrite to new API
                    const prompt = `${systemPrompt}\n\nHuman: ${userPrompt}\n\nAssistant:`;
                    const response = await fetch(apiUrl, {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                            'x-api-key': apiKey
                        },
                        body: JSON.stringify({
                            prompt: prompt,
                            model: model,
                            max_tokens_to_sample: 500,
                            stop_sequences: ['\n\nHuman:'],
                            temperature: 0.7,
                        })
                    });
                    const data = await response.json();
                    if (data.error) {
                        responseText = 'Error: ' + data.error.message;
                    } else {
                        responseText = data.completion.trim();
                    }
                }
                return responseText;
            } catch (error) {
                console.error(error);
                return 'Error: ' + error.message;
            }
        }

        async function askAI() {
            const inpt = document.getElementById('user-query');
            const userText = inpt.value.trim();
            if (!userText) return;
            inpt.value = '';

            // Get the system prompt from settings
            const systemPrompt = localStorage.getItem('system-prompt') || 'You are a helpful assistant.';

            // Display user's message
            addMessage('user', userText);

            // Add user message to chat history
            chat_history.push({role: 'user', content: userText});

            // Display bot is typing...
            const botMessageId = addMessage('bot', 'Typing...');

            // Query the API
            const responseText = await queryLLMAPI();

            // Update chat history with assistant's response
            chat_history.push({role: 'assistant', content: responseText});

            // Update bot's message
            updateMessage(botMessageId, responseText);
        }

        function addMessage(sender, text) {
            const chatHistory = document.getElementById('chat-history');
            const messageId = 'msg-' + Date.now() + Math.random().toString(36).substr(2, 9);
            const messageDiv = document.createElement('div');
            messageDiv.classList.add('message', sender);
            messageDiv.id = messageId;

            const messageContent = document.createElement('p');
            messageContent.classList.add('markdown-content'); // Add class for markdown styles

            // Parse Markdown and set as HTML content
            messageContent.innerHTML = marked.parse(text);
            for (let element of messageContent.querySelectorAll('code')) {
                hljs.highlightElement(element);
            }

            messageDiv.appendChild(messageContent);
            chatHistory.appendChild(messageDiv);
            chatHistory.scrollTop = chatHistory.scrollHeight;
            return messageId;
        }

        function updateMessage(messageId, newText) {
            const messageDiv = document.getElementById(messageId);
            if (messageDiv) {
                const messageContent = messageDiv.querySelector('p');

                // Parse Markdown and update HTML content
                messageContent.innerHTML = marked.parse(newText);
                for (let element of messageContent.querySelectorAll('code')) {
                    hljs.highlightElement(element);
                }
            }
        }
    </script>
</body>
</html>