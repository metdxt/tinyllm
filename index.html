<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>TinyLLM</title>
    <style>
        * {margin: 0;padding: 0;box-sizing: border-box;}
        body {
            font-family: Arial, sans-serif;
        }
        button {
            cursor: pointer;
        }
        /* Header Styles */
        header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            background-color: #0d6efd;
            color: #fff;
            padding: 10px 20px;
        }
        header h1 {
            font-size: 1.5em;
            margin: 0;
        }
        #settings-button {
            background: none;
            border: none;
            cursor: pointer;
            padding: 0;
            margin: 0;
            width: 32px;
            height: 32px;
            fill: #fff;
        }
        #settings-button svg {
            width: 100%;
            height: 100%;
        }
        #settings-button:hover {
            opacity: 0.8;
        }
        /* Dialog Styles */
        dialog {
            margin: auto;
            border: 1px solid #ccc;
            border-radius: 6pt;
            padding: 16px;
            box-shadow: 2pt 2pt 2pt #32323264;
            max-width: 500px;
            background-color: #fefefe;
        }
        dialog::backdrop {
            background: rgba(0, 0, 0, 0.3);
        }
        dialog header {
            display: flex;
            flex-direction: row;
            justify-content: space-between;
            align-items: center;
            border-bottom: 1px solid #ddd;
            padding-bottom: 10px;
            margin-bottom: 20px;
        }
        dialog header p {
            font-weight: bold;
            font-size: 1.5em;
            display: flex;
            align-items: center;
            margin: 0;
        }
        dialog header p::before {
            content: '⚙️';
            margin-right: 8px;
        }
        dialog header button {
            background: none;
            border: none;
            font-size: 1.2em;
            cursor: pointer;
        }
        dialog table {
            width: 100%;
            border-collapse: collapse;
        }
        dialog table td {
            padding: 8px 4px;
            vertical-align: middle;
        }
        dialog table input,
        dialog table select,
        dialog table textarea {
            width: 100%;
            padding: 6px;
            border: 1px solid #ccc;
            border-radius: 4px;
        }
        dialog button {
            margin-top: 20px;
            padding: 10px 16px;
            background-color: #0d6efd;
            color: #fff;
            border: none;
            border-radius: 4px;
            cursor: pointer;
        }
        dialog button:hover {
            background-color: #0b5ed7;
        }
        /* Rest of your existing styles for main, messages, etc. */
        main {
            max-width: 90ch;
            margin: 20px auto;
            border: 1px solid #323232;
            border-radius: 6pt;
            display: flex;
            flex-direction: column;
            overflow: hidden;
        }
        #chat-history {
            flex-grow: 1;
            padding: 16px;
            overflow-y: auto;
            background-color: #f9f9f9;
        }
        .message {
            margin-bottom: 16px;
            line-height: 1.4em;
        }
        .message.user {
            text-align: right;
        }
        .message.user p {
            background-color: #d1e7dd;
            color: #0f5132;
            display: inline-block;
            padding: 8px 12px;
            border-radius: 12px;
            max-width: 80%;
            word-wrap: break-word;
            white-space: pre-wrap;
        }
        .message.bot {
            text-align: left;
        }
        .message.bot p {
            background-color: #e2e3e5;
            color: #41464b;
            display: inline-block;
            padding: 8px 12px;
            border-radius: 12px;
            max-width: 80%;
            word-wrap: break-word;
            white-space: pre-wrap;
        }
        .form {
            display: flex;
            border-top: 1px solid #ddd;
        }
        .form textarea {
            flex-grow: 1;
            padding: 12px;
            border: none;
            font-size: 1em;
            resize: none;
            height: 60px;
        }
        .form button {
            padding: 0 16px;
            border: none;
            background-color: #0d6efd;
            color: white;
            font-size: 1em;
        }
        .form button:hover {
            background-color: #0b5ed7;
        }
        .disclaimer {
            margin-top: 20px;
            font-size: 0.9em;
            color: #555;
            text-align: center;
            font-style: italic;
        }
    </style>
</head>
<body>
    <header>
        <h1>TinyLLM</h1>
        <button onclick="openSettings()" id="settings-button" title="Settings">
            <!-- Settings Icon (SVG) -->
            <svg viewBox="0 0 24 24">
                <path fill="currentColor" d="M12 1a2 2 0 012 2v2.75a7.35 7.35 0 013.05 1.25l1.95-1.95a2 2 0 112.83 2.83l-1.95 1.95A7.35 7.35 0 0119.25 12H22a2 2 0 110 4h-2.75a7.35 7.35 0 01-1.25 3.05l1.95 1.95a2 2 0 11-2.83 2.83l-1.95-1.95A7.35 7.35 0 0112 19.25V22a2 2 0 11-4 0v-2.75a7.35 7.35 0 01-3.05-1.25l-1.95 1.95a2 2 0 11-2.83-2.83l1.95-1.95A7.35 7.35 0 014.75 12H2a2 2 0 110-4h2.75a7.35 7.35 0 011.25-3.05L4.05 3a2 2 0 112.83-2.83l1.95 1.95A7.35 7.35 0 0112 4.75V2a2 2 0 012-2zm0 6a6 6 0 100 12 6 6 0 000-12z"/>
            </svg>
        </button>
    </header>
    <dialog id="settings-dialog">
        <header>
            <p>Settings</p>
            <button onclick="closeSettings()" title="Close">&#x2715;</button>
        </header>
        <table>
            <tr>
                <td>API Type</td>
                <td>
                    <select id="api-type">
                        <option value="openai">OpenAI</option>
                        <option value="anthropic">Anthropic</option>
                    </select>
                </td>
            </tr>
            <tr>
                <td>API URL</td>
                <td><input type="text" id="api-url" placeholder="Enter API URL"></td>
            </tr>
            <tr>
                <td>API Key</td>
                <td><input type="password" id="api-key" placeholder="Enter API Key"></td>
            </tr>
            <tr>
                <td>Model</td>
                <td><input type="text" id="model" placeholder="e.g., gpt-3.5-turbo"></td>
            </tr>
            <tr>
                <td>System Prompt</td>
                <td><textarea id="system-prompt" placeholder="e.g., You are a helpful assistant." rows="4"></textarea></td>
            </tr>
        </table>
        <button onclick="saveSettings()">Save Settings</button>
        <div class="disclaimer">
            <p>Your settings are saved locally in your browser. However, the API Key, API URL, System Prompt, and your messages are sent to the LLM server (defined in API URL) when making requests.</p>
        </div>
    </dialog>
    <main>
        <div class="chat-history" id="chat-history"></div>
        <div class="form">
            <textarea id="user-query" placeholder="Type your message..." rows="3"></textarea>
            <button onclick="askAI()">Submit</button>
        </div>
    </main>
    <script>
        let settings_dialog = document.getElementById("settings-dialog");

        function openSettings() {
            settings_dialog.showModal();
        }

        function closeSettings() {
            settings_dialog.close();
        }

        function saveSettings() {
            // Save settings to local storage
            localStorage.setItem('api-type', document.getElementById('api-type').value);
            localStorage.setItem('api-url', document.getElementById('api-url').value);
            localStorage.setItem('api-key', document.getElementById('api-key').value);
            localStorage.setItem('model', document.getElementById('model').value);
            localStorage.setItem('system-prompt', document.getElementById('system-prompt').value);
            closeSettings();
        }

        function loadSettings() {
            // Load settings from local storage
            document.getElementById('api-type').value = localStorage.getItem('api-type') || 'openai';
            document.getElementById('api-url').value = localStorage.getItem('api-url') || '';
            document.getElementById('api-key').value = localStorage.getItem('api-key') || '';
            document.getElementById('model').value = localStorage.getItem('model') || 'gpt-3.5-turbo';
            document.getElementById('system-prompt').value = localStorage.getItem('system-prompt') || 'You are a helpful assistant.';
        }

        loadSettings();

        async function queryLLMAPI(systemPrompt, userPrompt) {
            const apiType = localStorage.getItem('api-type');
            const apiUrl = localStorage.getItem('api-url');
            const apiKey = localStorage.getItem('api-key');
            const model = localStorage.getItem('model') || 'gpt-3.5-turbo';

            if (!apiKey || !apiUrl) {
                alert('Please set your API key and API URL in the settings.');
                return "Error: API key or URL not set.";
            }

            try {
                let responseText = '';
                if (apiType === 'openai') {
                    const response = await fetch(apiUrl, {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                            'Authorization': 'Bearer ' + apiKey
                        },
                        body: JSON.stringify({
                            model: model,
                            max_tokens: 4096,
                            messages: [
                                { role: 'system', content: systemPrompt },
                                { role: 'user', content: userPrompt }
                            ]
                        })
                    });
                    const data = await response.json();
                    if (data.error) {
                        responseText = 'Error: ' + data.error.message;
                    } else {
                        responseText = data.choices[0].message.content.trim();
                    }
                } else if (apiType === 'anthropic') {
                    const prompt = `${systemPrompt}\n\nHuman: ${userPrompt}\n\nAssistant:`;
                    const response = await fetch(apiUrl, {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                            'x-api-key': apiKey
                        },
                        body: JSON.stringify({
                            prompt: prompt,
                            model: model,
                            max_tokens_to_sample: 500,
                            stop_sequences: ['\n\nHuman:'],
                            temperature: 0.7,
                        })
                    });
                    const data = await response.json();
                    if (data.error) {
                        responseText = 'Error: ' + data.error.message;
                    } else {
                        responseText = data.completion.trim();
                    }
                }
                return responseText;
            } catch (error) {
                console.error(error);
                return 'Error: ' + error.message;
            }
        }

        async function askAI() {
            const inpt = document.getElementById('user-query');
            const userText = inpt.value.trim();
            if (!userText) return;
            inpt.value = '';

            // Get the system prompt from settings
            const systemPrompt = localStorage.getItem('system-prompt') || 'You are a helpful assistant.';

            // Display user's message
            addMessage('user', userText);

            // Display bot is typing...
            const botMessageId = addMessage('bot', 'Typing...');

            // Query the API
            const responseText = await queryLLMAPI(systemPrompt, userText);

            // Update bot's message
            updateMessage(botMessageId, responseText);
        }

        function addMessage(sender, text) {
            const chatHistory = document.getElementById('chat-history');
            const messageId = 'msg-' + Date.now() + Math.random().toString(36).substr(2, 9);
            const messageDiv = document.createElement('div');
            messageDiv.classList.add('message', sender);
            messageDiv.id = messageId;

            const messageContent = document.createElement('p');
            messageContent.textContent = text;

            messageDiv.appendChild(messageContent);
            chatHistory.appendChild(messageDiv);
            chatHistory.scrollTop = chatHistory.scrollHeight;
            return messageId;
        }

        function updateMessage(messageId, newText) {
            const messageDiv = document.getElementById(messageId);
            if (messageDiv) {
                const messageContent = messageDiv.querySelector('p');
                messageContent.textContent = newText;
            }
        }
    </script>
</body>
</html>